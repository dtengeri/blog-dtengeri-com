---
title: Using Angular 4 with Phoenix Framework 1.3
layout: post
tags: elixir phoenix angular
---

Recently I started a new small project just to learn [Elixir](https://elixir-lang.org/), [Phoenix](http://phoenixframework.org/) and [Angular 4](https://angular.io/). Most of the resources I found online uses an older version of Phoenix and the integration of Angular looks difficult. I used the following two as inspiration, they worth checking out:
* [https://github.com/akeating/peap](https://github.com/akeating/peap)
* [https://medium.com/@zkayser/serving-a-bare-bones-angular-2-app-from-phoenix-d3f9d8ad52e5](https://medium.com/@zkayser/serving-a-bare-bones-angular-2-app-from-phoenix-d3f9d8ad52e5)

I wanted a simpler solution that is as close to the angular project generated by [angular-cli](https://github.com/angular/angular-cli) as possible and my angular project lives inside Phoenix. Suprisingly this is really easy. At the end I have a working `ng`, so I can use it to generate components and all other stuff.

You can fined the code here if you want to jump right in the coding.
[https://github.com/dtengeri/phoenix_angular](https://github.com/dtengeri/phoenix_angular)

Here are the steps I did to achive the required project structure.

After installing elixir and all its requirements, I created my project. Let's call it Hello.
I created it without Brunch, since `ng` uses webpack.

```bash
mix phx.new hello --no-brunch
```

So I have a fresh Phoenix application. Let's move on to the angular part.  

First, let's install `angular-cli` if we don't have it:
```bash
npm install -g @angular/cli
```
After that we can create our angular project, called `hello-angular`
```bash
ng new hello-angular
```

So now, we have two separate projects, let's add angular to our Phoenix application. Since Phoenix 1.3, the web-related files live under `lib/hello_web`, we'll put our angular files under `lib/hello_web/web/static`. Our files will be built and copied to Phoenix's `priv/static/js`.

First, let's copy `.angular-cli.json`, `package.json` and `tslint.json` to the root dir of our Phoenix directory. After that we should edit `.angular-cli.json` and modify paths defined in it to use the new place of our angular application:
```json
{
  "$schema": "./node_modules/@angular/cli/lib/config/schema.json",
  "project": {
    "name": "hello-angular"
  },
  "apps": [
    {
      "root": "lib/hello_web/web/static/src",
      "outDir": "priv/static/js",
      "assets": [
        "assets",
        "favicon.ico"
      ],
      "index": "index.html",
      "main": "main.ts",
      "polyfills": "polyfills.ts",
      "test": "test.ts",
      "tsconfig": "tsconfig.app.json",
      "testTsconfig": "tsconfig.spec.json",
      "prefix": "app",
      "styles": [
        "styles.css"
      ],
      "scripts": [],
      "environmentSource": "environments/environment.ts",
      "environments": {
        "dev": "environments/environment.ts",
        "prod": "environments/environment.prod.ts"
      }
    }
  ],
  "e2e": {
    "protractor": {
      "config": "lib/hello_web/web/static/protractor.conf.js"
    }
  },
  "lint": [
    {
      "project": "lib/hello_web/web/static/src/tsconfig.app.json",
      "exclude": "**/node_modules/**"
    },
    {
      "project": "lib/hello_web/web/static/src/tsconfig.spec.json",
      "exclude": "**/node_modules/**"
    },
    {
      "project": "lib/hello_web/web/static/e2e/tsconfig.e2e.json",
      "exclude": "**/node_modules/**"
    }
  ],
  "test": {
    "karma": {
      "config": "lib/hello_web/web/static/karma.conf.js"
    }
  },
  "defaults": {
    "styleExt": "css",
    "class": {
      "spec": false
    },
    "component": {}
  }
}
```
I edited the keys `apps.root`, `e2e.protractor.config`, the path to `tsconfig.*.json` files under `lint` and `test.karma.config`. I added the `lib/hello_web/web/static` path as a prefix to each of these keys. I changed `apps.outDir` to `priv/static/js`.

Now copy our angular files from `hello-angular` to `lib/hello_web/web/static` folder. We should have the following structure inside it:
```bash
lib/hello_web/web/static
├── e2e
├── karma.conf.js
├── protractor.conf.js
├── src
└── tsconfig.json
```

We can now remove the JS files from `priv/static/js` that Phoenix generated for us.
```bash
rm priv/static/js/*.js
```

Now let's include the required JS files in our HTML. We can replace our application's layout (`lib/hello_web/templates/layout/app.html.eex`) with the following:
```erb
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>HelloAngular</title>
    <base href="/">

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
  </head>
  <body>
    <app-root></app-root>

    <script type="text/javascript" src="<%= static_path(@conn, "/js/inline.bundle.js") %>"></script>
    <script type="text/javascript" src="<%= static_path(@conn, "/js/polyfills.bundle.js") %>"></script>
    <script type="text/javascript" src="<%= static_path(@conn, "/js/styles.bundle.js") %>"></script>
    <script type="text/javascript" src="<%= static_path(@conn, "/js/vendor.bundle.js") %>"></script>
    <script type="text/javascript" src="<%= static_path(@conn, "/js/main.bundle.js") %>"></script>
  </body>
</html>
```
Basically this is the content of `index.html` that `ng` builds for us. I only used `static_path` helper to include the required JS files. Since we want to use Angular for our frontend, we don't need the a placeholder in the layout that'll be replaced by Phoenix view.


We are done. It was simple, right? Let's try it out, install the dependencies. Go to your Phoenix application's root directory and run
```bash
yarn install
```

Now we can run `ng build` in our app's root directory. It'll compile our typescript files and copy the result in `priv/static/js`
```bash
priv
└── static
    ├── js
    │   ├── favicon.ico
    │   ├── index.html
    │   ├── inline.bundle.js
    │   ├── inline.bundle.js.map
    │   ├── main.bundle.js
    │   ├── main.bundle.js.map
    │   ├── polyfills.bundle.js
    │   ├── polyfills.bundle.js.map
    │   ├── styles.bundle.js
    │   ├── styles.bundle.js.map
    │   ├── vendor.bundle.js
    │   └── vendor.bundle.js.map
```

We can add ng build to to the watchers list in Phoenix, so out changes will be immediately visible when we are running Phoenix server. Add the following into the `watchers` array in `config/dev.exs`
```elixir
config :hello, HelloWeb.Endpoint,
  http: [port: 4000],
  debug_errors: true,
  code_reloader: true,
  check_origin: false,
  watchers: [
    ng: ["build", "--watch"]
  ]
```

We can use `ng generate` to create new components, we can run tests by `ng test`.

If you want to use `ng e2e`, you'll have to fix its config path. In `lib/hello_web/web/static/protractor.conf.js` change the path of `tsconfig.e2e.json` from the following:

```javascript
onPrepare() {
    require('ts-node').register({
      project: 'e2e/tsconfig.e2e.json'
    });
    jasmine.getEnv().addReporter(new SpecReporter({ spec: { displayStacktrace: true } }));
  }
```

to

```javascript
onPrepare() {
    require('ts-node').register({
      project: __dirname + '/e2e/tsconfig.e2e.json'
    });
    jasmine.getEnv().addReporter(new SpecReporter({ spec: { displayStacktrace: true } }));
  }
```

And update the `baseUrl` to `'http://localhost:4000/'`.


At this point you have a working Angular app that lives inside your main Phoenix application. 

You can find a prepared project as a starting point at 
[https://github.com/dtengeri/phoenix_angular](https://github.com/dtengeri/phoenix_angular)

From now on you can add more piecies to your app, like authentication, graphql or anything you'll need.

Happy coding! :)